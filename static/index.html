<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Transcribe UI</title>
  <style>
    #progress { width: 100%; height: 20px; background: #eee; margin-top: 1em; }
    #bar { height: 100%; width: 0; background: #6a5af9; }
    .segment { margin: 0.5em 0; }
  </style>
</head>
<body>
  <h1>Загрузите аудио для транскрипции</h1>
  <input type="file" id="fileInput">
  <button id="btn">Загрузить</button>
  <div id="progress"><div id="bar"></div></div>
  <div id="status"></div>
  <div id="segments"></div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const api = axios.create({ baseURL: "" });
document.getElementById("btn").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  const fd = new FormData(); fd.append("file", file);
  document.getElementById("status").innerText = "Загрузка...";
  const { data } = await api.post("/transcribe", fd, {
    onUploadProgress: e => {
      document.getElementById("bar").style.width = Math.round(e.loaded/e.total*100)+"%";
    }
  });
  pollResult(data.task_id);
};

async function pollResult(task_id) {
  document.getElementById("status").innerText = "Ожидание...";
  let res;
  while (true) {
    res = (await api.get(`/result/${task_id}`)).data;
    if (res.status === "SUCCESS" || res.segments) break;
    document.getElementById("status").innerText = res.status;
    await new Promise(r=>setTimeout(r,2000));
  }
  showSegments(res);
}

function showSegments({ segments, audio_filepath }) {
  document.getElementById("status").innerText = "Готово";
  const cont = document.getElementById("segments");
  segments.forEach(seg => {
    const div = document.createElement("div");
    div.className = "segment";
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.src = `${audio_filepath}#t=${seg.start},${seg.end}`;
    div.appendChild(audio);
    div.appendChild(document.createTextNode(` [${seg.start.toFixed(2)}–${seg.end.toFixed(2)}] ${seg.text}`));
    cont.appendChild(div);
  });
}
</script>
</body>
</html>