<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Audio Transcription</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    #status { margin-top: 1rem; font-weight: bold; }
    #output { white-space: pre-wrap; margin-top: 1rem; background: #f5f5f5; padding: 1rem; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Загрузите аудио для транскрипции</h1>
  <input type="file" id="audioFile" accept="audio/*" />
  <button id="uploadBtn">Загрузить</button>
  <div id="status"></div>
  <pre id="output"></pre>

  <script>
    const uploadBtn = document.getElementById('uploadBtn');
    const audioFile = document.getElementById('audioFile');
    const statusDiv = document.getElementById('status');
    const output = document.getElementById('output');
    let taskId = null;

    uploadBtn.addEventListener('click', async () => {
      if (!audioFile.files.length) {
        alert('Пожалуйста, выберите аудиофайл.');
        return;
      }
      statusDiv.textContent = 'Загрузка и запуск транскрипции…';
      output.textContent = '';

      const formData = new FormData();
      formData.append('file', audioFile.files[0]);

      const resp = await fetch('/transcribe', {
        method: 'POST',
        body: formData
      });
      if (!resp.ok) {
        statusDiv.textContent = 'Ошибка при отправке файла';
        return;
      }

      const data = await resp.json();
      taskId = data.task_id;
      statusDiv.textContent = `Задача запущена: ${taskId}. Ожидание результата…`;
      pollResult();
    });

    async function pollResult() {
      const res = await fetch(`/result/${taskId}`);
      const data = await res.json();

      if (data.status === 'SUCCESS') {
        statusDiv.textContent = 'Готово!';
        output.textContent = data.text;
      } else if (data.status === 'FAILED') {
        statusDiv.textContent = `Ошибка: ${data.error || 'неизвестная'}`;
      } else {
        statusDiv.textContent = `Статус: ${data.status}…`;
        setTimeout(pollResult, 2000);
      }
    }
  </script>
</body>
</html>